import React from 'react';
import { useQuery } from 'convex/react';
import { api } from '../../convex/_generated/api';
import './SimulationHistory.css';

interface Props {
  onLoadSimulation?: (simulationId: string) => void;
}

const SimulationHistory: React.FC<Props> = ({ onLoadSimulation }) => {
  const simulations = useQuery(api.simulations.getSimulations, { includePublic: true });
  const stats = useQuery(api.simulations.getSimulationStats, {});

  const formatDate = (timestamp: number) => {
    return new Date(timestamp).toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const getConfidenceColor = (confidence: number) => {
    if (confidence >= 4) return '#4CAF50';
    if (confidence >= 3.5) return '#FF9800';
    if (confidence >= 3) return '#2196F3';
    return '#9E9E9E';
  };

  if (!simulations || !stats) {
    return (
      <div className="history-loading">
        <div className="loading-spinner">
          <div className="spinner"></div>
          <p>å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="simulation-history">
      <div className="history-header">
        <h2>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´</h2>
        
        {stats && (
          <div className="stats-summary">
            <div className="stat-item">
              <span className="stat-number">{stats.totalCount}</span>
              <span className="stat-label">ç·ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°</span>
            </div>
            <div className="stat-item">
              <span className="stat-number">{stats.avgConfidence.toFixed(1)}</span>
              <span className="stat-label">å¹³å‡ä¿¡é ¼åº¦</span>
            </div>
            <div className="stat-item">
              <span className="stat-number">{stats.recentCount}</span>
              <span className="stat-label">ä»Šæœˆã®å®Ÿè¡Œæ•°</span>
            </div>
          </div>
        )}
      </div>

      <div className="simulations-grid">
        {simulations.length === 0 ? (
          <div className="empty-state">
            <h3>ã¾ã ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</h3>
            <p>æ–°ã—ã„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ã€æœªæ¥ã®è‡ªåˆ†ã‚’äºˆæ¸¬ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
          </div>
        ) : (
          simulations.map((simulation) => (
            <div key={simulation._id} className="simulation-card">
              <div className="card-header">
                <div className="simulation-date">
                  {formatDate(simulation.createdAt)}
                </div>
                <div
                  className="confidence-badge"
                  style={{ backgroundColor: getConfidenceColor(simulation.result.confidenceScore) }}
                >
                  ä¿¡é ¼åº¦: {simulation.result.confidenceScore.toFixed(1)}
                </div>
              </div>

              <div className="card-content">
                <h3>{simulation.result.targetYear}å¹´ã®äºˆæ¸¬</h3>
                <p className="summary">{simulation.result.overallSummary}</p>

                <div className="simulation-metadata">
                  <div className="meta-item">
                    <span className="meta-label">å¹´é½¢:</span>
                    <span>{simulation.lifeContext.age}æ­³</span>
                  </div>
                  <div className="meta-item">
                    <span className="meta-label">ã‚¹ãƒ†ãƒ¼ã‚¸:</span>
                    <span>{getLifeStageLabel(simulation.lifeContext.lifeStage)}</span>
                  </div>
                  <div className="meta-item">
                    <span className="meta-label">æ´»å‹•æ•°:</span>
                    <span>{simulation.currentActivities.length}å€‹</span>
                  </div>
                </div>

                <div className="projection-highlights">
                  {Object.entries(simulation.result.projections).map(([key, projection]) => (
                    <div key={key} className="projection-preview">
                      <span className="projection-category">{getCategoryLabel(key)}:</span>
                      <div
                        className="confidence-indicator"
                        style={{ backgroundColor: getConfidenceColor(projection.confidence) }}
                      ></div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="card-actions">
                {onLoadSimulation && (
                  <button
                    className="load-button"
                    onClick={() => onLoadSimulation(simulation._id)}
                  >
                    è©³ç´°ã‚’è¦‹ã‚‹
                  </button>
                )}
                <div className="visibility-indicator">
                  {simulation.isPublic ? 'ğŸŒ å…¬é–‹' : 'ğŸ”’ éå…¬é–‹'}
                </div>
              </div>
            </div>
          ))
        )}
      </div>

      {simulations.length > 0 && (
        <div className="history-footer">
          <p>éå»ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’å‚è€ƒã«ã€ç¾åœ¨ã®çŠ¶æ³ã‚„ç›®æ¨™ã‚’è¦‹ç›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
        </div>
      )}
    </div>
  );
};

const getLifeStageLabel = (stage: string): string => {
  const labels: Record<string, string> = {
    student: 'å­¦ç”Ÿ',
    early_career: 'ã‚­ãƒ£ãƒªã‚¢åˆæœŸ',
    mid_career: 'ã‚­ãƒ£ãƒªã‚¢ä¸­æœŸ',
    senior_career: 'ã‚­ãƒ£ãƒªã‚¢å¾ŒæœŸ',
    retirement: 'é€€è·å¾Œ'
  };
  return labels[stage] || stage;
};

const getCategoryLabel = (category: string): string => {
  const labels: Record<string, string> = {
    career: 'ã‚­ãƒ£ãƒªã‚¢',
    relationships: 'äººé–“é–¢ä¿‚',
    personal_growth: 'å€‹äººæˆé•·',
    lifestyle: 'ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«',
    achievements: 'é”æˆãƒ»æˆæœ'
  };
  return labels[category] || category;
};

export default SimulationHistory;