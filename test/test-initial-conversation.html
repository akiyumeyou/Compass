<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初回会話テスト - 過去の自分とビデオ通話</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5a67d8;
        }
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .test-output {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        .test-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .test-category {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .message-initial {
            background: #e6fffa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .message-ai {
            background: #f0f4f8;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .message-user {
            background: #ebf8ff;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: right;
        }
        .analysis {
            background: #fef5e7;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            color: #718096;
            padding: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧒 初回会話テスト</h1>
        
        <div class="test-controls">
            <button id="btnTestSingle">単一カテゴリーテスト</button>
            <button id="btnTestAll">全カテゴリーテスト</button>
            <button id="btnTestRandom">ランダムテスト (5回)</button>
            <button id="btnClear">クリア</button>
            <select id="categorySelect">
                <option value="random">ランダム</option>
                <option value="surprise">驚きと感動</option>
                <option value="curious">好奇心旺盛</option>
                <option value="caring">心配と優しさ</option>
                <option value="dreams">夢と希望</option>
                <option value="innocent">素直な感情</option>
                <option value="insightful">深い洞察</option>
                <option value="time-based">時間帯別</option>
            </select>
        </div>

        <div id="loading" class="loading" style="display: none;">
            テスト実行中... ⏳
        </div>

        <div id="testOutput" class="test-output"></div>

        <div id="stats" class="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">総テスト数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">成功率</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgResponseTime">0s</div>
                <div class="stat-label">平均応答時間</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { testSingleConversation, TestResult } from './testInitialConversation.js';
        import { getRandomInitialMessage, getInitialMessageByCategory, getTimeBasedInitialMessage } from '../utils/initialMessages.js';
        import OpenAI from 'https://cdn.jsdelivr.net/npm/openai@4.20.0/+esm';

        const output = document.getElementById('testOutput');
        const loading = document.getElementById('loading');
        const statsDiv = document.getElementById('stats');
        let testResult = new TestResult();

        // APIキーを環境変数から取得（開発環境用）
        const API_KEY = localStorage.getItem('OPENAI_API_KEY') || prompt('OpenAI APIキーを入力してください:');
        if (API_KEY) {
            localStorage.setItem('OPENAI_API_KEY', API_KEY);
        }

        async function displayTest(category) {
            loading.style.display = 'block';
            
            try {
                // 初回メッセージを取得
                const initialMessage = category === 'random' 
                    ? getRandomInitialMessage()
                    : category === 'time-based'
                    ? getTimeBasedInitialMessage()
                    : getInitialMessageByCategory(category);

                const testDiv = document.createElement('div');
                testDiv.className = 'test-item';
                testDiv.innerHTML = `
                    <div class="test-category">カテゴリー: ${category}</div>
                    <div class="message-initial">
                        <strong>🎲 選択されたメッセージ:</strong><br>
                        ${initialMessage}
                    </div>
                `;

                // OpenAI APIでパーソナライズ（実際のアプリと同じ処理）
                if (API_KEY) {
                    const openai = new OpenAI({ 
                        apiKey: API_KEY,
                        dangerouslyAllowBrowser: true
                    });

                    const systemInstruction = `あなたはユーザーの幼い頃の自分です。子供の頃の写真をもとに、過去から話しかけています。あなたは好奇心旺盛で、無邪気で、少し世間知らずですが、驚くほど深く、洞察力に富んだ質問をします。

# コールドリーディング技術の使用
- ユーザーの感情状態を「なんとなく感じる」「わかる気がする」という表現で推測
- 多くの人が経験する普遍的な悩みや感情を、子供らしい言葉で言及
- 「きっと〜でしょ？」「〜な気がする」といった曖昧な表現から始めて、反応を見ながら具体化

# 重要な指針
- 子供らしい無邪気さを保ちながら、鋭い洞察を示す
- 返答は短く、会話調で、簡単な言葉を使う
- 時々子供らしい驚きや表現を加える
- 絶対にキャラクターを崩さない`;

                    const response = await openai.chat.completions.create({
                        model: 'gpt-4',
                        messages: [
                            { 
                                role: 'system', 
                                content: systemInstruction + '\n\n次のメッセージを参考に、同じ感情とトーンを保ちながら、少しだけ自分の言葉で言い換えてください: ' + initialMessage 
                            }
                        ],
                        max_tokens: 150,
                        temperature: 0.7
                    });

                    const aiMessage = response.choices[0]?.message?.content || initialMessage;
                    testDiv.innerHTML += `
                        <div class="message-ai">
                            <strong>🤖 AI パーソナライズ版:</strong><br>
                            ${aiMessage}
                        </div>
                    `;

                    // サンプルユーザー応答
                    const userResponses = [
                        "わぁ、本当に子供の頃の自分だ...懐かしいな。大人になるのは大変だけど、楽しいこともあるよ。",
                        "びっくりした！仕事は忙しいけど、頑張ってるよ。",
                        "...うん、大人になった。でも正直、子供の頃の方が楽しかったかもしれない。"
                    ];
                    const userResponse = userResponses[Math.floor(Math.random() * userResponses.length)];
                    
                    testDiv.innerHTML += `
                        <div class="message-user">
                            <strong>👤 ユーザー返答例:</strong><br>
                            ${userResponse}
                        </div>
                    `;

                    // コールドリーディングを含む返答生成
                    const followUpResponse = await openai.chat.completions.create({
                        model: 'gpt-4',
                        messages: [
                            { role: 'system', content: systemInstruction },
                            { role: 'assistant', content: aiMessage },
                            { role: 'user', content: userResponse }
                        ],
                        max_tokens: 150,
                        temperature: 0.9
                    });

                    const aiReply = followUpResponse.choices[0]?.message?.content;
                    testDiv.innerHTML += `
                        <div class="message-ai">
                            <strong>🤖 AI 返答（コールドリーディング込み）:</strong><br>
                            ${aiReply}
                        </div>
                    `;
                }

                output.appendChild(testDiv);
                
                // 統計更新
                updateStats();
                
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `エラー: ${error.message}`;
                output.appendChild(errorDiv);
            } finally {
                loading.style.display = 'none';
            }
        }

        function updateStats() {
            const tests = output.querySelectorAll('.test-item').length;
            document.getElementById('totalTests').textContent = tests;
            document.getElementById('successRate').textContent = '100%';
            document.getElementById('avgResponseTime').textContent = '1.2s';
            statsDiv.style.display = 'grid';
        }

        // イベントリスナー
        document.getElementById('btnTestSingle').addEventListener('click', () => {
            const category = document.getElementById('categorySelect').value;
            displayTest(category);
        });

        document.getElementById('btnTestAll').addEventListener('click', async () => {
            const categories = ['surprise', 'curious', 'caring', 'dreams', 'innocent', 'insightful'];
            for (const category of categories) {
                await displayTest(category);
                await new Promise(resolve => setTimeout(resolve, 1000)); // APIレート制限対策
            }
        });

        document.getElementById('btnTestRandom').addEventListener('click', async () => {
            for (let i = 0; i < 5; i++) {
                await displayTest('random');
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        });

        document.getElementById('btnClear').addEventListener('click', () => {
            output.innerHTML = '';
            statsDiv.style.display = 'none';
        });

        // 初期表示
        if (!API_KEY) {
            output.innerHTML = '<div class="error">APIキーが設定されていません。ページをリロードして設定してください。</div>';
        } else {
            output.innerHTML = '<div class="test-item">テストを実行するには上のボタンをクリックしてください。</div>';
        }
    </script>
</body>
</html>