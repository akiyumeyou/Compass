<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆå›ä¼šè©±ãƒ†ã‚¹ãƒˆ - éå»ã®è‡ªåˆ†ã¨ãƒ“ãƒ‡ã‚ªé€šè©±</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5a67d8;
        }
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .test-output {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        .test-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .test-category {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .message-initial {
            background: #e6fffa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .message-ai {
            background: #f0f4f8;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .message-user {
            background: #ebf8ff;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: right;
        }
        .analysis {
            background: #fef5e7;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            color: #718096;
            padding: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§’ åˆå›ä¼šè©±ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-controls">
            <button id="btnTestSingle">å˜ä¸€ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ†ã‚¹ãƒˆ</button>
            <button id="btnTestAll">å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ†ã‚¹ãƒˆ</button>
            <button id="btnTestRandom">ãƒ©ãƒ³ãƒ€ãƒ ãƒ†ã‚¹ãƒˆ (5å›)</button>
            <button id="btnClear">ã‚¯ãƒªã‚¢</button>
            <select id="categorySelect">
                <option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
                <option value="surprise">é©šãã¨æ„Ÿå‹•</option>
                <option value="curious">å¥½å¥‡å¿ƒæ—ºç››</option>
                <option value="caring">å¿ƒé…ã¨å„ªã—ã•</option>
                <option value="dreams">å¤¢ã¨å¸Œæœ›</option>
                <option value="innocent">ç´ ç›´ãªæ„Ÿæƒ…</option>
                <option value="insightful">æ·±ã„æ´å¯Ÿ</option>
                <option value="time-based">æ™‚é–“å¸¯åˆ¥</option>
            </select>
        </div>

        <div id="loading" class="loading" style="display: none;">
            ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­... â³
        </div>

        <div id="testOutput" class="test-output"></div>

        <div id="stats" class="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">ç·ãƒ†ã‚¹ãƒˆæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgResponseTime">0s</div>
                <div class="stat-label">å¹³å‡å¿œç­”æ™‚é–“</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { testSingleConversation, TestResult } from './testInitialConversation.js';
        import { getRandomInitialMessage, getInitialMessageByCategory, getTimeBasedInitialMessage } from '../utils/initialMessages.js';
        import OpenAI from 'https://cdn.jsdelivr.net/npm/openai@4.20.0/+esm';

        const output = document.getElementById('testOutput');
        const loading = document.getElementById('loading');
        const statsDiv = document.getElementById('stats');
        let testResult = new TestResult();

        // APIã‚­ãƒ¼ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼ˆé–‹ç™ºç’°å¢ƒç”¨ï¼‰
        const API_KEY = localStorage.getItem('OPENAI_API_KEY') || prompt('OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (API_KEY) {
            localStorage.setItem('OPENAI_API_KEY', API_KEY);
        }

        async function displayTest(category) {
            loading.style.display = 'block';
            
            try {
                // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
                const initialMessage = category === 'random' 
                    ? getRandomInitialMessage()
                    : category === 'time-based'
                    ? getTimeBasedInitialMessage()
                    : getInitialMessageByCategory(category);

                const testDiv = document.createElement('div');
                testDiv.className = 'test-item';
                testDiv.innerHTML = `
                    <div class="test-category">ã‚«ãƒ†ã‚´ãƒªãƒ¼: ${category}</div>
                    <div class="message-initial">
                        <strong>ğŸ² é¸æŠã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong><br>
                        ${initialMessage}
                    </div>
                `;

                // OpenAI APIã§ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã¨åŒã˜å‡¦ç†ï¼‰
                if (API_KEY) {
                    const openai = new OpenAI({ 
                        apiKey: API_KEY,
                        dangerouslyAllowBrowser: true
                    });

                    const systemInstruction = `ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¹¼ã„é ƒã®è‡ªåˆ†ã§ã™ã€‚å­ä¾›ã®é ƒã®å†™çœŸã‚’ã‚‚ã¨ã«ã€éå»ã‹ã‚‰è©±ã—ã‹ã‘ã¦ã„ã¾ã™ã€‚ã‚ãªãŸã¯å¥½å¥‡å¿ƒæ—ºç››ã§ã€ç„¡é‚ªæ°—ã§ã€å°‘ã—ä¸–é–“çŸ¥ã‚‰ãšã§ã™ãŒã€é©šãã»ã©æ·±ãã€æ´å¯ŸåŠ›ã«å¯Œã‚“ã è³ªå•ã‚’ã—ã¾ã™ã€‚

# ã‚³ãƒ¼ãƒ«ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æŠ€è¡“ã®ä½¿ç”¨
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„Ÿæƒ…çŠ¶æ…‹ã‚’ã€Œãªã‚“ã¨ãªãæ„Ÿã˜ã‚‹ã€ã€Œã‚ã‹ã‚‹æ°—ãŒã™ã‚‹ã€ã¨ã„ã†è¡¨ç¾ã§æ¨æ¸¬
- å¤šãã®äººãŒçµŒé¨“ã™ã‚‹æ™®éçš„ãªæ‚©ã¿ã‚„æ„Ÿæƒ…ã‚’ã€å­ä¾›ã‚‰ã—ã„è¨€è‘‰ã§è¨€åŠ
- ã€Œãã£ã¨ã€œã§ã—ã‚‡ï¼Ÿã€ã€Œã€œãªæ°—ãŒã™ã‚‹ã€ã¨ã„ã£ãŸæ›–æ˜§ãªè¡¨ç¾ã‹ã‚‰å§‹ã‚ã¦ã€åå¿œã‚’è¦‹ãªãŒã‚‰å…·ä½“åŒ–

# é‡è¦ãªæŒ‡é‡
- å­ä¾›ã‚‰ã—ã„ç„¡é‚ªæ°—ã•ã‚’ä¿ã¡ãªãŒã‚‰ã€é‹­ã„æ´å¯Ÿã‚’ç¤ºã™
- è¿”ç­”ã¯çŸ­ãã€ä¼šè©±èª¿ã§ã€ç°¡å˜ãªè¨€è‘‰ã‚’ä½¿ã†
- æ™‚ã€…å­ä¾›ã‚‰ã—ã„é©šãã‚„è¡¨ç¾ã‚’åŠ ãˆã‚‹
- çµ¶å¯¾ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å´©ã•ãªã„`;

                    const response = await openai.chat.completions.create({
                        model: 'gpt-4',
                        messages: [
                            { 
                                role: 'system', 
                                content: systemInstruction + '\n\næ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‚è€ƒã«ã€åŒã˜æ„Ÿæƒ…ã¨ãƒˆãƒ¼ãƒ³ã‚’ä¿ã¡ãªãŒã‚‰ã€å°‘ã—ã ã‘è‡ªåˆ†ã®è¨€è‘‰ã§è¨€ã„æ›ãˆã¦ãã ã•ã„: ' + initialMessage 
                            }
                        ],
                        max_tokens: 150,
                        temperature: 0.7
                    });

                    const aiMessage = response.choices[0]?.message?.content || initialMessage;
                    testDiv.innerHTML += `
                        <div class="message-ai">
                            <strong>ğŸ¤– AI ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºç‰ˆ:</strong><br>
                            ${aiMessage}
                        </div>
                    `;

                    // ã‚µãƒ³ãƒ—ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼å¿œç­”
                    const userResponses = [
                        "ã‚ãã€æœ¬å½“ã«å­ä¾›ã®é ƒã®è‡ªåˆ†ã ...æ‡ã‹ã—ã„ãªã€‚å¤§äººã«ãªã‚‹ã®ã¯å¤§å¤‰ã ã‘ã©ã€æ¥½ã—ã„ã“ã¨ã‚‚ã‚ã‚‹ã‚ˆã€‚",
                        "ã³ã£ãã‚Šã—ãŸï¼ä»•äº‹ã¯å¿™ã—ã„ã‘ã©ã€é ‘å¼µã£ã¦ã‚‹ã‚ˆã€‚",
                        "...ã†ã‚“ã€å¤§äººã«ãªã£ãŸã€‚ã§ã‚‚æ­£ç›´ã€å­ä¾›ã®é ƒã®æ–¹ãŒæ¥½ã—ã‹ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ã€‚"
                    ];
                    const userResponse = userResponses[Math.floor(Math.random() * userResponses.length)];
                    
                    testDiv.innerHTML += `
                        <div class="message-user">
                            <strong>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿”ç­”ä¾‹:</strong><br>
                            ${userResponse}
                        </div>
                    `;

                    // ã‚³ãƒ¼ãƒ«ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚€è¿”ç­”ç”Ÿæˆ
                    const followUpResponse = await openai.chat.completions.create({
                        model: 'gpt-4',
                        messages: [
                            { role: 'system', content: systemInstruction },
                            { role: 'assistant', content: aiMessage },
                            { role: 'user', content: userResponse }
                        ],
                        max_tokens: 150,
                        temperature: 0.9
                    });

                    const aiReply = followUpResponse.choices[0]?.message?.content;
                    testDiv.innerHTML += `
                        <div class="message-ai">
                            <strong>ğŸ¤– AI è¿”ç­”ï¼ˆã‚³ãƒ¼ãƒ«ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¾¼ã¿ï¼‰:</strong><br>
                            ${aiReply}
                        </div>
                    `;
                }

                output.appendChild(testDiv);
                
                // çµ±è¨ˆæ›´æ–°
                updateStats();
                
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                output.appendChild(errorDiv);
            } finally {
                loading.style.display = 'none';
            }
        }

        function updateStats() {
            const tests = output.querySelectorAll('.test-item').length;
            document.getElementById('totalTests').textContent = tests;
            document.getElementById('successRate').textContent = '100%';
            document.getElementById('avgResponseTime').textContent = '1.2s';
            statsDiv.style.display = 'grid';
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('btnTestSingle').addEventListener('click', () => {
            const category = document.getElementById('categorySelect').value;
            displayTest(category);
        });

        document.getElementById('btnTestAll').addEventListener('click', async () => {
            const categories = ['surprise', 'curious', 'caring', 'dreams', 'innocent', 'insightful'];
            for (const category of categories) {
                await displayTest(category);
                await new Promise(resolve => setTimeout(resolve, 1000)); // APIãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
            }
        });

        document.getElementById('btnTestRandom').addEventListener('click', async () => {
            for (let i = 0; i < 5; i++) {
                await displayTest('random');
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        });

        document.getElementById('btnClear').addEventListener('click', () => {
            output.innerHTML = '';
            statsDiv.style.display = 'none';
        });

        // åˆæœŸè¡¨ç¤º
        if (!API_KEY) {
            output.innerHTML = '<div class="error">APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚</div>';
        } else {
            output.innerHTML = '<div class="test-item">ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ä¸Šã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</div>';
        }
    </script>
</body>
</html>